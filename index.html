<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300FFF0'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Professional AI Fact Verification Platform</title>
    
    <!-- Professional Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent-blue': '#3B82F6',
                        'accent-cyan': '#06B6D4',
                        'accent-indigo': '#6366F1',
                        'accent-purple': '#8B5CF6',
                        'accent-violet': '#7C3AED',
                        'surface': '#0f172a',
                        'surface-light': '#1e293b',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                        'display': ['Space Grotesk', 'Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fade-in 0.5s ease-out',
                        'typing-cursor': 'typing-cursor 1s infinite',
                        'flow-gradient': 'flow-gradient 15s ease-in-out infinite',
                        'subtle-glow': 'subtle-glow 3s ease-in-out infinite alternate',
                        'pulse-mic': 'pulse-mic 1s ease-in-out infinite',
                    },
                }
            }
        }
    </script>
    
    <style>
        @keyframes fade-in {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typing-cursor {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes flow-gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes subtle-glow {
            0% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
            100% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
        }

        @keyframes pulse-mic {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Beautiful Flowing Background */
        body {
            background: linear-gradient(
                -45deg, 
                #1e3a8a, 
                #1e40af, 
                #3730a3, 
                #4338ca, 
                #6366f1, 
                #0ea5e9, 
                #06b6d4,
                #0891b2,
                #1e293b
            );
            background-size: 400% 400%;
            animation: flow-gradient 15s ease-in-out infinite;
            min-height: 100vh;
            color: white;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .glass-panel-elevated {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #3B82F6;
            margin-left: 2px;
            animation: typing-cursor 1s infinite;
            box-shadow: 0 0 8px #3B82F6;
        }

        .voice-visualizer {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }

        .voice-bar {
            width: 3px;
            background: linear-gradient(to top, #3B82F6, #06B6D4);
            border-radius: 2px;
            transition: all 0.1s ease;
        }

        .professional-button {
            background: linear-gradient(135deg, #3B82F6, #06B6D4);
            transition: all 0.3s ease;
        }

        .professional-button:hover {
            background: linear-gradient(135deg, #2563EB, #0891B2);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .glass-panel {
                border-radius: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Local Storage Keys
        const API_KEY_STORAGE = 'openrouter_api_key';
        const SETTINGS_STORAGE = 'fact_checker_settings';

        // Utility function to create short summary
        const createSummary = (text, maxLength = 200) => {
            if (!text || text.length <= maxLength) return text;
            
            // Find first complete sentence within limit
            const sentences = text.match(/[^\.!?]+[\.!?]+/g) || [];
            let summary = '';
            
            for (const sentence of sentences) {
                if ((summary + sentence).length <= maxLength) {
                    summary += sentence;
                } else {
                    break;
                }
            }
            
            // If no complete sentence fits, truncate
            if (!summary) {
                summary = text.substring(0, maxLength).trim() + '...';
            }
            
            return summary.trim();
        };

        // API Key Manager Component
        const ApiKeyManager = ({ apiKey, onApiKeyChange }) => {
            const [isEditing, setIsEditing] = useState(!apiKey);
            const [tempKey, setTempKey] = useState(apiKey || '');
            const [showKey, setShowKey] = useState(false);

            const handleSave = () => {
                if (tempKey.trim()) {
                    onApiKeyChange(tempKey.trim());
                    setIsEditing(false);
                    localStorage.setItem(API_KEY_STORAGE, tempKey.trim());
                }
            };

            const handleClear = () => {
                onApiKeyChange('');
                setTempKey('');
                setIsEditing(true);
                localStorage.removeItem(API_KEY_STORAGE);
            };

            const maskKey = (key) => {
                if (!key) return 'Not configured';
                return key.substring(0, 8) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            };

            return (
                <div className="glass-panel p-4 rounded-xl mb-4 border border-blue-400/40">
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="text-lg font-semibold text-blue-300 flex items-center gap-2">
                            üîë OpenRouter API Key
                        </h3>
                        <div className="flex gap-2">
                            {apiKey && !isEditing && (
                                <button
                                    onClick={() => setShowKey(!showKey)}
                                    className="p-2 text-xs rounded-lg glass-panel border-gray-600 text-gray-300 hover:border-blue-400 transition-colors"
                                    title={showKey ? 'Hide key' : 'Show key'}
                                >
                                    {showKey ? 'üôà' : 'üëÅÔ∏è'}
                                </button>
                            )}
                            {apiKey && !isEditing && (
                                <button
                                    onClick={() => setIsEditing(true)}
                                    className="p-2 text-xs rounded-lg glass-panel border-blue-400/50 text-blue-300 hover:border-blue-400 transition-colors"
                                >
                                    ‚úèÔ∏è Edit
                                </button>
                            )}
                            {apiKey && (
                                <button
                                    onClick={handleClear}
                                    className="p-2 text-xs rounded-lg glass-panel border-red-400/50 text-red-300 hover:border-red-400 transition-colors"
                                >
                                    üóëÔ∏è Clear
                                </button>
                            )}
                        </div>
                    </div>

                    {isEditing ? (
                        <div className="space-y-3">
                            <input
                                type="password"
                                value={tempKey}
                                onChange={(e) => setTempKey(e.target.value)}
                                placeholder="Enter your OpenRouter API key (sk-or-v1-...)"
                                className="w-full p-3 rounded-lg bg-surface border border-blue-400/40 text-gray-100 placeholder-gray-400 focus:border-blue-400 focus:outline-none transition-colors font-mono text-sm"
                            />
                            <div className="flex gap-2 flex-wrap">
                                <button
                                    onClick={handleSave}
                                    disabled={!tempKey.trim()}
                                    className="px-4 py-2 rounded-lg professional-button text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                                >
                                    üíæ Save Key
                                </button>
                                {apiKey && (
                                    <button
                                        onClick={() => {
                                            setIsEditing(false);
                                            setTempKey(apiKey);
                                        }}
                                        className="px-4 py-2 rounded-lg glass-panel border border-gray-600 text-gray-300 hover:border-blue-400 transition-colors text-sm"
                                    >
                                        ‚ùå Cancel
                                    </button>
                                )}
                            </div>
                            <p className="text-xs text-gray-400 leading-relaxed">
                                Get your API key from <a href="https://openrouter.ai/keys" target="_blank" className="text-blue-400 hover:text-blue-300">openrouter.ai/keys</a>. 
                                Your key is stored locally and never sent to our servers.
                            </p>
                        </div>
                    ) : (
                        <div className="flex items-center justify-between">
                            <div className="font-mono text-sm text-gray-300">
                                {showKey ? apiKey : maskKey(apiKey)}
                            </div>
                            <div className="text-xs text-green-400">‚úÖ Configured</div>
                        </div>
                    )}
                </div>
            );
        };

        // Voice Visualizer
        const VoiceVisualizer = ({ isActive }) => (
            <div className="voice-visualizer">
                {[...Array(5)].map((_, i) => (
                    <div 
                        key={i} 
                        className="voice-bar" 
                        style={{
                            height: isActive ? `${8 + Math.random() * 12}px` : '4px',
                            filter: isActive ? 'drop-shadow(0 0 3px currentColor)' : 'none'
                        }} 
                    />
                ))}
            </div>
        );

        // Status Component
        const StatusIndicator = ({ status, isProcessing, isStreaming, apiKey }) => (
            <div className="flex items-center gap-2 lg:gap-4 flex-wrap">
                <div className={`
                    px-3 lg:px-6 py-2 lg:py-3 rounded-lg font-medium text-xs lg:text-sm transition-all duration-500 glass-panel
                    ${isStreaming ? 'border-cyan-400 text-cyan-300 animate-subtle-glow' : 
                      isProcessing ? 'border-blue-400 text-blue-300' : 
                      apiKey ? 'border-green-400 text-green-300' : 'border-red-400 text-red-300'}
                `}>
                    <div className="flex items-center gap-2 lg:gap-3">
                        <div className={`w-2 lg:w-3 h-2 lg:h-3 rounded-full ${
                            isStreaming ? 'bg-cyan-400' : 
                            isProcessing ? 'bg-blue-400 animate-pulse' : 
                            apiKey ? 'bg-green-400' : 'bg-red-400'
                        }`} />
                        <div className="font-semibold">
                            {isStreaming ? 'Analyzing' : 
                             isProcessing ? 'Processing' : 
                             apiKey ? 'Ready' : 'API Key Required'}
                        </div>
                    </div>
                </div>
                <div className="text-xs font-mono text-gray-300 px-2 lg:px-4 py-1 lg:py-2 rounded-lg glass-panel">
                    API: <span className={apiKey ? "text-green-400" : "text-red-400"}>
                        {apiKey ? '‚úÖ Set' : '‚ùå Missing'}
                    </span>
                </div>
            </div>
        );

        // Combined Input with Voice
        const CombinedInput = ({ 
            value, 
            onChange, 
            onSubmit, 
            disabled, 
            isStreaming, 
            apiKey,
            onSpeechResult 
        }) => {
            const [isListening, setIsListening] = useState(false);
            const [isSupported, setIsSupported] = useState(false);
            const recognitionRef = useRef(null);

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    setIsSupported(true);
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'en-US';
                    
                    recognitionRef.current.onresult = (event) => {
                        const transcript = Array.from(event.results)
                            .map(result => result[0])
                            .map(result => result.transcript)
                            .join('');
                        
                        onChange({ target: { value: transcript } });
                        
                        if (event.results[event.results.length - 1].isFinal) {
                            onSpeechResult(transcript);
                            setIsListening(false);
                        }
                    };
                    
                    recognitionRef.current.onerror = () => {
                        setIsListening(false);
                    };
                    
                    recognitionRef.current.onend = () => {
                        setIsListening(false);
                    };
                }
            }, [onChange, onSpeechResult]);

            const toggleVoice = () => {
                if (!recognitionRef.current) return;
                
                if (isListening) {
                    recognitionRef.current.stop();
                    setIsListening(false);
                } else {
                    onChange({ target: { value: '' } }); // Clear text for voice input
                    recognitionRef.current.start();
                    setIsListening(true);
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    onSubmit(e);
                }
            };

            return (
                <form onSubmit={onSubmit} className="p-4 lg:p-6 border-t border-blue-400/30 glass-panel">
                    <div className="relative">
                        <textarea
                            value={value}
                            onChange={onChange}
                            onKeyDown={handleKeyDown}
                            placeholder={
                                isListening 
                                    ? "üé§ Listening... Speak your question now" 
                                    : apiKey 
                                        ? "Type or speak your fact-checking question..."
                                        : "Please configure your API key first..."
                            }
                            rows={window.innerWidth < 768 ? 2 : 3}
                            disabled={disabled || !apiKey}
                            className={`w-full p-4 pr-20 lg:pr-24 rounded-xl bg-surface border text-gray-100 placeholder-gray-400 focus:outline-none transition-all duration-300 resize-none text-sm lg:text-base leading-relaxed
                                ${isListening 
                                    ? 'border-red-400 bg-red-900/20' 
                                    : 'border-blue-400/40 focus:border-blue-400'
                                }
                                ${!apiKey ? 'opacity-50' : ''}
                            `}
                        />
                        
                        {/* Voice Button Inside Textarea */}
                        <div className="absolute right-2 top-2 flex flex-col gap-2">
                            {isSupported && (
                                <button
                                    type="button"
                                    onClick={toggleVoice}
                                    disabled={disabled || !apiKey}
                                    className={`
                                        p-2 lg:p-3 rounded-lg transition-all duration-300 font-medium text-xs lg:text-sm
                                        ${isListening 
                                            ? 'bg-red-500/30 border-2 border-red-400 text-red-300 animate-pulse-mic' 
                                            : 'glass-panel border border-blue-400/50 text-blue-300 hover:border-blue-400'
                                        }
                                        ${!apiKey ? 'opacity-50 cursor-not-allowed' : ''}
                                    `}
                                    title={isListening ? 'Stop recording' : 'Start voice input'}
                                >
                                    {isListening ? (
                                        <span className="flex items-center gap-1">
                                            ‚èπÔ∏è
                                        </span>
                                    ) : (
                                        'üé§'
                                    )}
                                </button>
                            )}
                            
                            {/* Submit Button */}
                            <button
                                type="submit"
                                disabled={disabled || !value.trim() || !apiKey}
                                className={`
                                    p-2 lg:p-3 rounded-lg transition-all duration-300 font-bold text-xs lg:text-sm
                                    ${disabled || !apiKey
                                        ? 'bg-gray-600/50 border border-gray-500/50 text-gray-400 cursor-not-allowed'
                                        : 'professional-button text-white hover:shadow-lg'
                                    }
                                `}
                                title="Send message"
                            >
                                üöÄ
                            </button>
                        </div>
                        
                        {/* Voice Visualizer */}
                        {isListening && (
                            <div className="absolute bottom-2 left-4 flex items-center gap-2">
                                <VoiceVisualizer isActive={true} />
                                <span className="text-xs text-red-400 animate-pulse">Recording...</span>
                            </div>
                        )}

                        {/* Streaming Indicator */}
                        {isStreaming && (
                            <div className="absolute bottom-2 right-20 lg:right-24 text-blue-400 text-xs lg:text-sm font-mono animate-pulse">
                                ‚ö° Analyzing...
                            </div>
                        )}
                    </div>
                </form>
            );
        };

        // Enhanced Message Component with Expandable Content
        const MessageBubble = ({ message, isStreaming, onSpeak, isSpeaking, onExpand }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isUser = message.role === 'user';
            const time = message.timestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

            // Create summary for AI messages
            const summary = !isUser && message.content ? createSummary(message.content) : message.content;
            const needsExpansion = !isUser && message.content && message.content.length > 200;

            const handleToggleExpand = () => {
                if (needsExpansion) {
                    setIsExpanded(!isExpanded);
                    if (!isExpanded && onExpand) {
                        onExpand(message.id);
                    }
                }
            };

            const displayContent = isUser ? message.content : (isExpanded ? message.content : summary);

            return (
                <div className="animate-fade-in">
                    <div className={`
                        max-w-full lg:max-w-4xl p-4 lg:p-6 rounded-xl transition-all duration-300
                        ${isUser 
                            ? 'ml-auto glass-panel border-blue-400/50' 
                            : 'mr-auto glass-panel-elevated border-cyan-400/50'
                        }
                        ${isStreaming ? 'animate-subtle-glow' : ''}
                    `}>
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center gap-3 lg:gap-4">
                                <div className={`
                                    w-8 lg:w-10 h-8 lg:h-10 rounded-lg flex items-center justify-center text-xs lg:text-sm font-bold
                                    ${isUser 
                                        ? 'bg-blue-600/30 border border-blue-400/60 text-blue-200' 
                                        : 'bg-cyan-600/30 border border-cyan-400/60 text-cyan-200'
                                    }
                                `}>
                                    {isUser ? 'U' : 'AI'}
                                </div>
                                <div>
                                    <div className={`font-bold text-base lg:text-lg ${isUser ? 'text-blue-200' : 'text-cyan-200'}`}>
                                        {isUser ? 'Your Query' : 'AI Analysis'}
                                    </div>
                                    <div className="text-xs text-gray-400 font-mono flex items-center gap-2">
                                        <span>{time}</span>
                                        {isStreaming && (
                                            <span className="text-cyan-400 animate-pulse">‚ö° Live</span>
                                        )}
                                        {needsExpansion && !isExpanded && (
                                            <span className="text-yellow-400">üìÑ Summary</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            {!isUser && message.content && (
                                <div className="flex items-center gap-2 lg:gap-3">
                                    {isSpeaking && <VoiceVisualizer isActive={true} />}
                                    <button
                                        onClick={() => onSpeak(displayContent)}
                                        className="p-2 lg:p-3 rounded-lg glass-panel border border-purple-400/40 text-purple-300 hover:border-purple-400 transition-colors duration-300"
                                        title="Listen to response"
                                    >
                                        <span className="hidden lg:inline">{isSpeaking ? '‚èπÔ∏è Stop' : 'üîä Listen'}</span>
                                        <span className="lg:hidden">{isSpeaking ? '‚èπÔ∏è' : 'üîä'}</span>
                                    </button>
                                </div>
                            )}
                        </div>
                        
                        <div className="text-gray-100 leading-relaxed">
                            <pre className="whitespace-pre-wrap font-sans text-sm lg:text-base">
                                {displayContent}
                                {isStreaming && <span className="streaming-cursor"></span>}
                            </pre>
                            
                            {/* Expand/Collapse Button */}
                            {needsExpansion && (
                                <div className="mt-4 pt-3 border-t border-gray-600">
                                    <button
                                        onClick={handleToggleExpand}
                                        className="flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 transition-colors duration-300"
                                    >
                                        {isExpanded ? (
                                            <>
                                                ‚¨ÜÔ∏è Show Less
                                            </>
                                        ) : (
                                            <>
                                                ‚¨áÔ∏è Read More Details
                                            </>
                                        )}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Control Panel (Desktop Only)
        const ControlPanel = ({ settings, onSettingsChange, onClearChat, isVisible }) => {
            if (!isVisible) return null;
            
            return (
                <div className="w-80 glass-panel border-r border-blue-400/30 p-6 overflow-y-auto hidden lg:block">
                    <div className="mb-8">
                        <h2 className="text-2xl font-display font-bold mb-2 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                            AI Fact Verification Hub
                        </h2>
                        <p className="text-gray-300 leading-relaxed">
                            Professional misinformation detection with smart response summarization
                        </p>
                    </div>

                    <div className="space-y-6">
                        <div className="space-y-3">
                            <label className="text-sm font-semibold text-blue-200 flex items-center gap-2">
                                üîß Analysis Model
                            </label>
                            <select
                                value={settings.model}
                                onChange={(e) => onSettingsChange({model: e.target.value})}
                                className="w-full p-4 rounded-lg bg-surface border border-blue-400/40 text-gray-100 focus:border-blue-400 focus:outline-none transition-colors duration-300 font-medium"
                            >
                                <option value="deepseek/deepseek-r1">üèÜ DeepSeek R1 (Premium)</option>
                                <option value="deepseek/deepseek-r1:free">‚ö° DeepSeek R1 (Standard)</option>
                                <option value="deepseek/deepseek-r1:floor">üí° DeepSeek R1 (Basic)</option>
                            </select>
                        </div>

                        <div className="space-y-3">
                            <label className="text-sm font-semibold text-cyan-200 flex items-center gap-2">
                                üéµ Voice Settings
                            </label>
                            <select
                                value={settings.voiceRate || 1}
                                onChange={(e) => onSettingsChange({voiceRate: parseFloat(e.target.value)})}
                                className="w-full p-4 rounded-lg bg-surface border border-cyan-400/40 text-gray-100 focus:border-cyan-400 focus:outline-none transition-colors duration-300 font-medium"
                            >
                                <option value={0.8}>üêå Slower (0.8x)</option>
                                <option value={1}>‚ö° Normal (1.0x)</option>
                                <option value={1.2}>üöÄ Faster (1.2x)</option>
                                <option value={1.5}>üí® Rapid (1.5x)</option>
                            </select>
                        </div>

                        <div className="pt-6 border-t border-gray-600">
                            <button
                                onClick={onClearChat}
                                className="w-full p-4 rounded-lg bg-red-500/20 border border-red-400/50 text-red-300 hover:bg-red-500/30 transition-colors duration-300 font-semibold"
                            >
                                üóëÔ∏è Clear Chat History
                            </button>
                        </div>

                        <div className="pt-4 space-y-2 glass-panel p-4 rounded-lg">
                            <div className="text-xs text-gray-300 font-semibold mb-2">Features</div>
                            <div className="space-y-1 text-xs">
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Smart Summaries:</span>
                                    <span className="text-cyan-400">‚úÖ Active</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Voice Input:</span>
                                    <span className="text-blue-400">‚úÖ Enabled</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Real-time Stream:</span>
                                    <span className="text-green-400">‚úÖ Live</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Mobile Settings Panel
        const MobileSettings = ({ settings, onSettingsChange, onClearChat, isOpen, onClose }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 lg:hidden">
                    <div className="absolute inset-0 bg-black/50" onClick={onClose}></div>
                    <div className="absolute bottom-0 left-0 right-0 glass-panel-elevated rounded-t-2xl p-6 max-h-[80vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-blue-300">Settings</h3>
                            <button
                                onClick={onClose}
                                className="p-2 rounded-lg glass-panel border border-gray-600 text-gray-300"
                            >
                                ‚úï
                            </button>
                        </div>

                        <div className="space-y-6">
                            <div className="space-y-3">
                                <label className="text-sm font-semibold text-blue-200">üîß Analysis Model</label>
                                <select
                                    value={settings.model}
                                    onChange={(e) => onSettingsChange({model: e.target.value})}
                                    className="w-full p-4 rounded-lg bg-surface border border-blue-400/40 text-gray-100 focus:border-blue-400 focus:outline-none"
                                >
                                    <option value="deepseek/deepseek-r1">üèÜ DeepSeek R1 (Premium)</option>
                                    <option value="deepseek/deepseek-r1:free">‚ö° DeepSeek R1 (Standard)</option>
                                    <option value="deepseek/deepseek-r1:floor">üí° DeepSeek R1 (Basic)</option>
                                </select>
                            </div>

                            <div className="space-y-3">
                                <label className="text-sm font-semibold text-cyan-200">üéµ Voice Speed</label>
                                <select
                                    value={settings.voiceRate || 1}
                                    onChange={(e) => onSettingsChange({voiceRate: parseFloat(e.target.value)})}
                                    className="w-full p-4 rounded-lg bg-surface border border-cyan-400/40 text-gray-100 focus:border-cyan-400 focus:outline-none"
                                >
                                    <option value={0.8}>üêå Slower (0.8x)</option>
                                    <option value={1}>‚ö° Normal (1.0x)</option>
                                    <option value={1.2}>üöÄ Faster (1.2x)</option>
                                    <option value={1.5}>üí® Rapid (1.5x)</option>
                                </select>
                            </div>

                            <button
                                onClick={() => {
                                    onClearChat();
                                    onClose();
                                }}
                                className="w-full p-4 rounded-lg bg-red-500/20 border border-red-400/50 text-red-300 font-semibold"
                            >
                                üóëÔ∏è Clear Chat History
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Main Application
        const App = () => {
            // Load saved API key and settings
            const [apiKey, setApiKey] = useState(() => {
                return localStorage.getItem(API_KEY_STORAGE) || '';
            });
            
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem(SETTINGS_STORAGE);
                return saved ? JSON.parse(saved) : {
                    model: 'deepseek/deepseek-r1:free', // Default to free tier for better reliability
                    voiceRate: 1
                };
            });

            const [messages, setMessages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [isStreaming, setIsStreaming] = useState(false);
            const [inputValue, setInputValue] = useState('');
            const [streamingMessageId, setStreamingMessageId] = useState(null);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [speakingMessageId, setSpeakingMessageId] = useState(null);
            const [showMobileSettings, setShowMobileSettings] = useState(false);
            const messagesEndRef = useRef(null);

            // Get current date for AI context
            const getCurrentDate = () => {
                const now = new Date();
                return now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    timeZone: 'Asia/Kolkata'
                });
            };

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            useEffect(() => {
                localStorage.setItem(SETTINGS_STORAGE, JSON.stringify(settings));
            }, [settings]);

            const updateSettings = (newSettings) => {
                setSettings(prev => ({ ...prev, ...newSettings }));
            };

            const clearChat = () => {
                setMessages([]);
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    setIsSpeaking(false);
                    setSpeakingMessageId(null);
                }
            };

            const handleSpeechResult = (transcript) => {
                // Auto-submit voice input if it seems complete
                if (transcript.trim().length > 10) {
                    setTimeout(() => {
                        sendMessage();
                    }, 1000);
                }
            };

            const speakText = useCallback((text, messageId) => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    setIsSpeaking(false);
                    setSpeakingMessageId(null);
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.voiceRate || 1;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                
                utterance.onstart = () => {
                    setIsSpeaking(true);
                    setSpeakingMessageId(messageId);
                };
                
                utterance.onend = () => {
                    setIsSpeaking(false);
                    setSpeakingMessageId(null);
                };

                speechSynthesis.speak(utterance);
            }, [settings.voiceRate]);

            const addMessage = (role, content, model = null) => {
                const message = {
                    id: Date.now().toString(),
                    role,
                    content,
                    timestamp: new Date(),
                    model
                };
                setMessages(prev => [...prev, message]);
                return message.id;
            };

            const updateMessage = (messageId, newContent) => {
                setMessages(prev => prev.map(msg => 
                    msg.id === messageId 
                        ? { ...msg, content: newContent }
                        : msg
                ));
            };

            const sendMessage = async (e) => {
                if (e) e.preventDefault();
                
                if (!inputValue.trim() || isLoading) return;

                if (!apiKey) {
                    alert('Please enter your OpenRouter API key first!');
                    return;
                }

                const userMessage = inputValue.trim();
                addMessage('user', userMessage);
                setInputValue('');
                setIsLoading(true);

                const assistantId = addMessage('assistant', '', settings.model);

                try {
                    // Try streaming first
                    setIsStreaming(true);
                    setStreamingMessageId(assistantId);
                    
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin,
                            'X-Title': 'Professional AI Fact Verification Platform'
                        },
                        body: JSON.stringify({
                            model: settings.model,
                            messages: [
                                {
                                    role: 'system',
                                    content: `You are a professional fact-checking system. Today's date is ${getCurrentDate()}. Provide concise, evidence-based analysis. Start with a brief summary, then provide detailed evidence if requested. Keep initial responses under 200 words unless specifically asked for more details. Structure responses clearly with: Quick Assessment, Key Evidence, and Confidence Level.`
                                },
                                {
                                    role: 'user',
                                    content: userMessage
                                }
                            ],
                            stream: true,
                            temperature: 0.3,
                            max_tokens: 2000
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6).trim();
                                if (data === '[DONE]') continue;
                                if (data === '') continue;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    const delta = parsed.choices?.[0]?.delta?.content;
                                    
                                    if (delta) {
                                        fullContent += delta;
                                        updateMessage(assistantId, fullContent);
                                    }
                                } catch (e) {
                                    // Skip invalid JSON
                                    console.log('Skipping invalid JSON:', data);
                                }
                            }
                        }
                    }

                    // Auto-speak summary when complete
                    if (fullContent) {
                        setTimeout(() => {
                            const summary = createSummary(fullContent);
                            speakText(summary, assistantId);
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('Streaming failed, trying non-streaming:', error);
                    setIsStreaming(false);
                    
                    // Fallback to non-streaming
                    try {
                        const fallbackResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json',
                                'HTTP-Referer': window.location.origin,
                                'X-Title': 'Professional AI Fact Verification Platform'
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: [
                                    {
                                        role: 'system',
                                        content: `You are a professional fact-checking system. Today's date is ${getCurrentDate()}. Provide concise analysis with clear evidence.`
                                    },
                                    {
                                        role: 'user',
                                        content: userMessage
                                    }
                                ],
                                stream: false,
                                temperature: 0.3,
                                max_tokens: 2000
                            })
                        });

                        if (fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            const fallbackMessage = fallbackData.choices[0].message.content;
                            updateMessage(assistantId, fallbackMessage);
                            
                            // Auto-speak fallback response summary
                            setTimeout(() => {
                                const summary = createSummary(fallbackMessage);
                                speakText(summary, assistantId);
                            }, 500);
                        } else {
                            const errorText = await fallbackResponse.text();
                            console.error('Fallback API Error:', errorText);
                            updateMessage(assistantId, `Sorry, I encountered an issue: ${fallbackResponse.status}. Please check your API key or try again.`);
                        }
                    } catch (fallbackError) {
                        console.error('Both streaming and fallback failed:', fallbackError);
                        updateMessage(assistantId, 'Analysis system temporarily unavailable. Please check your connection and API key.');
                    }
                } finally {
                    setIsLoading(false);
                    setIsStreaming(false);
                    setStreamingMessageId(null);
                }
            };

            const handleExpand = (messageId) => {
                // Could potentially fetch more detailed analysis here
                console.log('Expanding message:', messageId);
            };

            return (
                <div className="min-h-screen flex">
                    <ControlPanel 
                        settings={settings}
                        onSettingsChange={updateSettings}
                        onClearChat={clearChat}
                        isVisible={apiKey}
                    />
                    
                    <div className="flex-1 flex flex-col">
                        {/* Header */}
                        <div className="p-4 lg:p-6 border-b border-blue-400/30 glass-panel">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-xl lg:text-3xl font-display font-bold mb-2 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                                        AI Fact Verification Platform
                                    </h1>
                                    <p className="text-sm lg:text-base text-gray-300 hidden sm:block">Smart summaries with voice input and expandable details</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <StatusIndicator 
                                        status="ready" 
                                        isProcessing={isLoading} 
                                        isStreaming={isStreaming}
                                        apiKey={apiKey}
                                    />
                                    <button
                                        onClick={() => setShowMobileSettings(true)}
                                        className="lg:hidden p-2 rounded-lg glass-panel border border-blue-400/50 text-blue-300"
                                    >
                                        ‚öôÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-4 lg:p-6 space-y-4 lg:space-y-6">
                            {/* API Key Manager */}
                            <ApiKeyManager apiKey={apiKey} onApiKeyChange={setApiKey} />

                            {messages.length === 0 ? (
                                <div className="max-w-4xl mx-auto text-center p-6 lg:p-12 glass-panel-elevated rounded-2xl border border-blue-400/40">
                                    <div className="w-16 lg:w-20 h-16 lg:h-20 mx-auto mb-6 lg:mb-8 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-2xl flex items-center justify-center border border-blue-400/40">
                                        <span className="text-3xl lg:text-4xl">üéØ</span>
                                    </div>
                                    <h3 className="text-2xl lg:text-3xl font-display font-bold mb-4 lg:mb-6 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                                        Smart AI Fact Verification
                                    </h3>
                                    <p className="text-gray-300 mb-4 leading-relaxed text-base lg:text-lg max-w-2xl mx-auto">
                                        Type or speak your questions. Get concise answers with the option to expand for full details.
                                    </p>
                                    <p className="text-blue-400 mb-6 lg:mb-8 font-semibold">
                                        üé§ Voice input ‚Ä¢ üìù Smart summaries ‚Ä¢ üîç Expandable details
                                    </p>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6 max-w-4xl mx-auto">
                                        <div className="p-4 lg:p-6 glass-panel rounded-2xl border border-blue-400/40 hover:border-blue-400/60 transition-colors duration-300">
                                            <div className="text-2xl lg:text-3xl mb-4">üéôÔ∏è</div>
                                            <div className="font-bold text-blue-300 mb-2">Voice + Text Input</div>
                                            <div className="text-sm text-gray-400">Combined input for maximum convenience</div>
                                        </div>
                                        <div className="p-4 lg:p-6 glass-panel rounded-2xl border border-cyan-400/40 hover:border-cyan-400/60 transition-colors duration-300">
                                            <div className="text-2xl lg:text-3xl mb-4">‚ö°</div>
                                            <div className="font-bold text-cyan-300 mb-2">Smart Summaries</div>
                                            <div className="text-sm text-gray-400">Quick answers with detailed expansion</div>
                                        </div>
                                        <div className="p-4 lg:p-6 glass-panel rounded-2xl border border-indigo-400/40 hover:border-indigo-400/60 transition-colors duration-300">
                                            <div className="text-2xl lg:text-3xl mb-4">üîç</div>
                                            <div className="font-bold text-indigo-300 mb-2">Evidence-Based</div>
                                            <div className="text-sm text-gray-400">Professional fact-checking analysis</div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                messages.map(message => (
                                    <MessageBubble 
                                        key={message.id} 
                                        message={message} 
                                        isStreaming={streamingMessageId === message.id}
                                        onSpeak={(text) => speakText(text, message.id)}
                                        isSpeaking={speakingMessageId === message.id}
                                        onExpand={handleExpand}
                                    />
                                ))
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Combined Input */}
                        <CombinedInput 
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            onSubmit={sendMessage}
                            disabled={isLoading}
                            isStreaming={isStreaming}
                            apiKey={apiKey}
                            onSpeechResult={handleSpeechResult}
                        />
                    </div>

                    <MobileSettings
                        settings={settings}
                        onSettingsChange={updateSettings}
                        onClearChat={clearChat}
                        isOpen={showMobileSettings}
                        onClose={() => setShowMobileSettings(false)}
                    />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
